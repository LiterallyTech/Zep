<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Zep Search Engine</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --color-bg: #0f0f0f;
  --color-bg-secondary: #1a1a1a;
  --color-text: #fff;
  --color-muted: #999;
  --color-primary: #8B0000; /* Blood red */
  --radius: 8px;
  --transition-fast: 0.2s ease;
}

body {
  background-color: var(--color-bg);
  font-family: 'Poppins', sans-serif;
  margin: 0;
  padding: 20px;
  color: var(--color-text);
}

.container {
  max-width: 800px;
  margin: 0 auto;
  background-color: var(--color-bg-secondary);
  border-radius: var(--radius);
  padding: 20px;
  border: 1px solid #2c2c2c;
}

.header {
  font-size: 2em;
  font-weight: 700;
  text-align: center;
  margin-bottom: 20px;
  color: var(--color-primary);
}

.search-box {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border-radius: var(--radius);
  border: 1px solid #444;
  background-color: var(--color-bg);
  color: var(--color-text);
  margin-bottom: 10px;
}

.search-button {
  background-color: var(--color-primary);
  color: var(--color-text);
  border: none;
  padding: 12px;
  font-size: 16px;
  cursor: pointer;
  border-radius: var(--radius);
}

.search-button:hover {
  background-color: #6e0000;
}

.results {
  margin-top: 20px;
}

.result-item {
  background-color: var(--color-bg-secondary);
  border: 1px solid #2c2c2c;
  padding: 15px;
  border-radius: var(--radius);
  margin-bottom: 15px;
}

.result-title {
  font-size: 1.2em;
  font-weight: 600;
  color: var(--color-primary);
  text-decoration: none;
}

.result-title:hover {
  text-decoration: underline;
}

.result-desc {
  margin-top: 5px;
  font-size: 0.95em;
  color: var(--color-text);
}

.result-meta {
  margin-top: 5px;
  font-size: 0.85em;
  color: var(--color-muted);
}

.vote-section {
  margin-top: 10px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.vote-button {
  background-color: #333;
  color: var(--color-text);
  border: 1px solid #444;
  padding: 5px 10px;
  cursor: pointer;
  border-radius: var(--radius);
}

.vote-button.active {
  background-color: var(--color-primary);
  color: #fff;
}

.vote-count {
  font-size: 0.85em;
  margin-right: 10px;
}

.notification {
  position: fixed;
  bottom: 10px;
  right: 10px;
  background-color: var(--color-bg-secondary);
  border: 1px solid #2c2c2c;
  padding: 10px;
  color: var(--color-text);
  display: none;
  border-radius: var(--radius);
}

.suggestion {
  margin-top: 10px;
  font-size: 0.95em;
  color: var(--color-muted);
}

.suggestion a {
  color: var(--color-primary);
  text-decoration: none;
}

.suggestion a:hover {
  text-decoration: underline;
}
</style>
</head>
<body>
<div class="container">
  <div class="header">Zep Search Engine</div>
  <div>
    <input type="text" id="search" class="search-box" placeholder="Search your sites...">
    <button id="searchButton" class="search-button">Search</button>
  </div>
  <div id="suggestion" class="suggestion"></div>
  <div id="results" class="results"></div>
</div>

<div id="notification" class="notification"></div>

<script>
// Your original JS logic is preserved exactly
const dataURL = "https://literallytech.github.io/Zep/data/index.json";
const votesURL = "https://literallytech.github.io/Zep/data/votes.json";
let entries = [], fuse = null, userVotes = {};
const resultsEl = document.getElementById('results');
const suggestionEl = document.getElementById('suggestion');
const searchEl = document.getElementById('search');
const searchButton = document.getElementById('searchButton');
const notifyEl = document.getElementById('notification');

function loadFuseAndInit(data){
  return new Promise((resolve,reject)=>{
    if(window.Fuse){resolve(); return;}
    const s=document.createElement('script');
    s.src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2";
    s.onload=()=>resolve();
    s.onerror=reject;
    document.head.appendChild(s);
  }).then(()=>{
    const options = { keys:[{name:"name",weight:0.35},{name:"desc",weight:0.25},{name:"keywords",weight:0.2},{name:"title",weight:0.2}], threshold:0.36, includeScore:true };
    fuse = new Fuse(entries, options);
  });
}

async function loadData(){
  try {
    const [rData,rVotes]=await Promise.all([fetch(dataURL+"?t="+Date.now()).then(r=>r.ok?r.json():[]), fetch(votesURL+"?t="+Date.now()).then(r=>r.ok?r.json():[])]);
    entries = (rData||[]).map(item=>{
      const v=(rVotes||[]).find(x=>x.url===item.url)||{};
      return {...item, voteScore:v.score||0, positiveVotes:v.positive||0, negativeVotes:v.negative||0};
    });
    entries.sort((a,b)=>(b.voteScore||0)-(a.voteScore||0));
    await loadFuseAndInit(entries);
  } catch(err){
    resultsEl.innerHTML='<div style="text-align:center;color:#999">Failed to load data.</div>';
    console.error(err);
  }
}

function renderResults(list){
  if(!list||!list.length){resultsEl.innerHTML='<div style="text-align:center;color:#999">No results.</div>';return;}
  const html = list.map(r=>{
    const item = r.item||r;
    const hv=userVotes[item.url];
    return `
    <div class="result-item" data-url="${escapeHtml(item.url)}">
      <a class="result-title" href="${escapeHtml(item.url)}" target="_blank">${escapeHtml(item.name)}</a>
      <div class="result-desc">${escapeHtml(item.desc||item.description||item.title||'')}</div>
      <div class="result-meta">${item.pageType?`<span>[${escapeHtml(item.pageType)}]</span>`:''}${typeof item.voteScore==='number'?` <span>Score:${item.voteScore>0?'+':''}${item.voteScore}</span>`:''}</div>
      <div class="vote-section">
        <button class="vote-button ${hv==='positive'?'active':''}" data-action="vote" data-type="positive">▲</button>
        <span class="vote-count">${item.positiveVotes||0}</span>
        <button class="vote-button ${hv==='negative'?'active':''}" data-action="vote" data-type="negative">▼</button>
        <span class="vote-count">${item.negativeVotes||0}</span>
      </div>
    </div>`;
  }).join('');
  resultsEl.innerHTML=html;
  resultsEl.querySelectorAll('[data-action="vote"]').forEach(btn=>{btn.addEventListener('click', onVoteClick);});
}

function onVoteClick(e){
  const btn=e.currentTarget;
  const type=btn.dataset.type;
  const root=btn.closest('.result-item');
  const url=root&&root.getAttribute('data-url');
  if(!url)return;
  userVotes[url]=type;
  root.querySelectorAll('.vote-button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  showNotification('Vote recorded');
  fetch('https://literallytech.github.io/Zep/api/collect-vote',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url,type,timestamp:Date.now()})}).catch(()=>{});
}

function doSearch(q){
  if(!fuse||!q.trim()){resultsEl.innerHTML='';suggestionEl.textContent='';return;}
  const res=fuse.search(q);
  if(!res.length){resultsEl.innerHTML='<div style="text-align:center;color:#999">No results found.</div>';suggestionEl.textContent='';return;}
  if(res[0].score>0.26){
    suggestionEl.innerHTML=`Did you mean: <a href="#" id="didYouMean">${escapeHtml(res[0].item.name)}</a>?`;
    const link=document.getElementById('didYouMean');
    if(link) link.addEventListener('click', (ev)=>{ ev.preventDefault(); searchEl.value=res[0].item.name; doSearch(res[0].item.name); });
  } else { suggestionEl.textContent=''; }
  renderResults(res);
}

function escapeHtml(s){ if(!s&&s!==0)return''; return String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

let notifyTimer=null;
function showNotification(msg){ clearTimeout(notifyTimer); notifyEl.textContent=msg; notifyEl.style.display='block'; notifyTimer=setTimeout(()=>{ notifyEl.style.display='none'; },2000); }

function initHandlers(){
  searchEl.addEventListener('input', e=>doSearch(e.target.value));
  searchButton.addEventListener('click', ()=>doSearch(searchEl.value));
  searchEl.addEventListener('keydown', ev=>{ if(ev.key==='Enter'){ doSearch(searchEl.value); } });
}

(async function bootstrap(){
  initHandlers();
  await loadData();
  if(entries&&entries.length){ renderResults(entries.slice(0,12).map(i=>({item:i}))); }
})();
window._zep={ doSearch, entries };
</script>
</body>
</html>
