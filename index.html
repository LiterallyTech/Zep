<!DOCTYPE html>
<html lang="en" x-data="zepSearch()">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Zep Search</title>

  <!-- üß© Libraries -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.4/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@4.1.1/animate.min.css">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.14.0/dist/cdn.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script>

  <style>
    body {
      background-color: #f4f5f7;
    }
    .didyoumean span {
      color: #2563eb;
      cursor: pointer;
      font-weight: 600;
    }
    .didyoumean span:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen">

  <!-- Header -->
  <header class="bg-gray-900 text-white w-full text-center py-4 text-2xl font-bold shadow-md">
    Zep üîç
  </header>

  <!-- Search Box -->
  <main class="mt-10 w-full max-w-2xl px-4">
    <input
      x-model="query"
      @input="search"
      type="text"
      placeholder="Search your sites..."
      class="w-full p-3 border-2 border-gray-300 rounded-xl shadow focus:outline-none focus:ring-2 focus:ring-blue-400 focus:border-blue-400 transition"
    >

    <p x-show="suggestion" class="didyoumean text-gray-600 mt-2 italic animate__animated animate__fadeIn">
      Did you mean: <span @click="applySuggestion(suggestion)" x-text="suggestion"></span>?
    </p>

    <div id="results" class="mt-6 space-y-4 animate__animated animate__fadeIn"></div>
  </main>

  <script>
    const dataURL = "https://cdn.jsdelivr.net/gh/LiterallyTech/Zep@main/data/sites.txt";

    function zepSearch() {
      return {
        query: "",
        suggestion: "",
        entries: [],
        fuse: null,

        async search() {
          const q = this.query.trim();
          const resultsDiv = document.getElementById("results");
          const markInstance = new Mark(resultsDiv);
          markInstance.unmark();
          resultsDiv.innerHTML = "";

          if (!q) return;

          // üåÄ Always fetch the latest data from GitHub each search
          try {
            const res = await fetch(dataURL + "?_=" + Date.now());
            const text = await res.text();
            this.parseEntries(text);

            if (this.entries.length === 0) {
              resultsDiv.innerHTML = `<p class='text-gray-500 text-center'>No sites found in data file.</p>`;
              return;
            }

            this.fuse = new Fuse(this.entries, {
              keys: ["name", "desc"],
              threshold: 0.4,
              includeScore: true
            });

            const results = this.fuse.search(q);

            if (results.length === 0) {
              this.showSuggestion(q, resultsDiv);
              return;
            }

            // Display results
            resultsDiv.innerHTML = results.map(r => `
              <div class="bg-white p-4 rounded-xl shadow hover:shadow-md transition transform hover:-translate-y-0.5">
                <a href="${r.item.url}" target="_blank" class="text-blue-600 font-semibold text-lg hover:underline">
                  ${r.item.name}
                </a>
                <p class="text-gray-700 mt-1">${r.item.desc}</p>
              </div>
            `).join("");

            // Highlight keywords
            markInstance.mark(q, { separateWordSearch: true });

            // Suggest if slightly off
            this.showSuggestion(q, resultsDiv, results);
          } catch (err) {
            console.error("Failed to load data:", err);
            resultsDiv.innerHTML = `<p class='text-center text-red-500'>Failed to fetch data from GitHub.</p>`;
          }
        },

        parseEntries(text) {
          this.entries = [];
          const blocks = text.trim().split(/\n\s*\n/);
          for (const block of blocks) {
            const entry = {};
            for (const line of block.split("\n")) {
              if (line.startsWith("Name:")) entry.name = line.replace("Name:", "").trim();
              if (line.startsWith("URL:")) entry.url = line.replace("URL:", "").trim();
              if (line.startsWith("Description:")) entry.desc = line.replace("Description:", "").trim();
            }
            if (entry.name && entry.url && entry.desc) this.entries.push(entry);
          }
        },

        showSuggestion(q, resultsDiv, results = []) {
          const allWords = this.entries.flatMap(e =>
            (e.name + " " + e.desc).toLowerCase().split(/\s+/)
          );
          const suggestion = this.findClosestWord(q.toLowerCase(), allWords);
          if (suggestion && suggestion !== q.toLowerCase()) {
            this.suggestion = suggestion;
          } else {
            this.suggestion = "";
          }
          if (!results.length) {
            resultsDiv.innerHTML = "<p class='text-gray-500 text-center'>No results found.</p>";
          }
        },

        applySuggestion(s) {
          this.query = s;
          this.search();
        },

        findClosestWord(word, list) {
          let minDist = Infinity;
          let best = "";
          for (const w of list) {
            const d = this.levenshtein(word, w);
            if (d < minDist) {
              minDist = d;
              best = w;
            }
          }
          return minDist <= 2 ? best : "";
        },

        levenshtein(a, b) {
          const matrix = Array.from({ length: a.length + 1 }, () => []);
          for (let i = 0; i <= a.length; i++) matrix[i][0] = i;
          for (let j = 0; j <= b.length; j++) matrix[0][j] = j;
          for (let i = 1; i <= a.length; i++) {
            for (let j = 1; j <= b.length; j++) {
              const cost = a[i - 1] === b[j - 1] ? 0 : 1;
              matrix[i][j] = Math.min(
                matrix[i - 1][j] + 1,
                matrix[i][j - 1] + 1,
                matrix[i - 1][j - 1] + cost
              );
            }
          }
          return matrix[a.length][b.length];
        }
      };
    }
  </script>
</body>
</html>
